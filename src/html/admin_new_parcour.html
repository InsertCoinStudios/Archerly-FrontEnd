<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="../css/style.css">
  </head>
  <body>
    <div class="header-bg">
      <a href="admin_main.html"><img src="../img/return.png" class="header-img"></a>
    </div>
    <div class="bg-wrapper">
    <div class="bg-dark-admin">
    </div>
    <div class="bg-wrapper-2">
    <div class="bg-light-admin">

    </div>
    </div>
    </div>
    <div class="container">
    <div class="bg-wrapper-header">
  <div class="header-admin">
    <h1>
      Erstellen
    </h1>
      <form id="loginForm">

      <div class="data-input-admin">
      <label for="parcour-name" class="label-admin">Parkour:</label>
      <input type="text" id ="parcour-name" name="parcour-name" placeholder="Safari - Route" class="textbox-admin">
      </div>

      <div class="data-input-admin">
      <label for="parcour-loc" class="label-admin">Ort:</label>
      <input type="text" id="parcour-loc" name="parcour-loc" placeholder="Wüste 02" class="textbox-admin">
      </div>

  </form>
  </div>
  </div>

      <div class="content-top">
          <div style="text-align: left; margin-left: 20px;">
            <br>

            <p>Schwierigkeit:</p>
              <div class="radio-btns">
                <input type="radio" id="easy" name="difficulty" value="easy">
                <label for="easy">Leicht</label>
                <input type="radio" id="middle" name="difficulty" value="middle">
                <label for="middle">Mittel</label>
                <input type="radio" id="hard" name="difficulty" value="hard">
                <label for="hard">Schwer</label>
              </div>
          </div>
          <p class="divider"></p>
      </div>
      <div class="content">
        <div class="table-header">
          <p class="left">Tiere</p>
          <p class="right">
            <!-- DYNAMISCHER WERT:
             LIEST DIE ANZAHL DER TIERE IN DER TABELLE AUS
             ERLAUBT ES NICHT WENIGER, ALS DIE FIX GESETZTE ANZAHL ZU MANIPULIEREN (DAS TIER MUSS EXTRA PER KLICK GELÖSCHT WERDEN)
             ERLAUBT ES TIERE HINZUZUFÜGEN, JEDOCH MUSS DER DATENSATZ FIX BEARBEITET WERDEN-->
            Anzahl:
            <input type="number" class="animal-counter" name="counter" min="1" max="100">
          </p>
        </div>
        <div class="table_users_admin-editor">
          <!-- DYNAMISCHE ANPASSUNG: USERNAMEN, USERANZAHL -->
          
          <!--
          
          <div class="non-collapse-top-admin">
            <span class="drag-handle">&#x2630;</span>
            <span class="animal-text">Tier</span>
            <a href="admin_animal.html?newParcourId=1&animalIndex=0"><img class="edit_png" src="../img/edit_square.png" alt="edit"></a>
          </div>
          <div class="non-collapse-admin">
            <span class="drag-handle">&#x2630;</span>
            <span class="animal-text">Tier</span>
            <a href="admin_animal.html?newParcourId=1&animalIndex=1"><img class="edit_png" src="../img/edit_square.png" alt="edit"></a>
          </div>
          <div class="non-collapse-bottom-admin">
            <span class="drag-handle">&#x2630;</span>
            <span class="animal-text">Tier</span>
            <a href="admin_animal.html?newParcourId=1&animalIndex=2"><img class="edit_png" src="../img/edit_square.png" alt="edit"></a>
          </div>

          -->

        </div>
        <button class="blue-btn-admin" id="saveBtn" style="float: right; margin: 10px;">
  Speichern
</button>

      </div>
    </div>
        <div class="target-circle" id="register_2-admin">
          <span class="circle1">
            <span class="circle2">
              <span class="circle3">
                <span class="circle4">
                  <span class="circle5">
                    <span class="circle6">
                    </span>
                  </span>
                </span>
              </span>
            </span>
          </span>
        </div>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// =========================
// AUTO-RESET BEIM VERLASSEN DER SEITE
// =========================
window.addEventListener("beforeunload", (event) => {
  // Prüfen, wohin der Benutzer navigiert
  // Wenn admin_animal.html im Ziel enthalten ist, nichts löschen
  const destination = document.activeElement?.href || document.referrer || "";
  if (!destination.includes("admin_animal.html")) {
    localStorage.removeItem("draft_newParcour");
  }
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // =========================
  // BASIS-ELEMENTE
  // =========================
  const animalList = document.querySelector('.table_users_admin-editor');
  const animalCounter = document.querySelector('.animal-counter');
  const saveBtn = document.getElementById("saveBtn");
  const nameInput = document.getElementById("parcour-name");
  const locInput = document.getElementById("parcour-loc");
  const difficultyRadios = document.querySelectorAll('input[name="difficulty"]');

  // =========================
  // FUNKTIONEN
  // =========================
  function refreshRowClasses() {
    const rows = animalList.children;
    Array.from(rows).forEach(row => {
      row.classList.remove(
        'non-collapse-top-admin',
        'non-collapse-bottom-admin',
        'non-collapse-admin'
      );
      row.classList.add('non-collapse-admin');
    });
    if (rows.length > 0) {
      rows[0].classList.replace('non-collapse-admin', 'non-collapse-top-admin');
      rows[rows.length - 1].classList.replace('non-collapse-admin', 'non-collapse-bottom-admin');
    }
  }

  function getAnimalOrder() {
    return Array.from(
      animalList.querySelectorAll('.animal-text')
    ).map(el => el.innerText.trim());
  }

  function createAnimalRow(name = 'Tier', index = null) {
    if (index === null) index = animalList.children.length;

    const div = document.createElement('div');
    div.className = 'non-collapse-admin';
    div.innerHTML = `
      <span class="drag-handle">&#x2630;</span>
      <span class="animal-text">${name}</span>
      <a href="admin_animal.html?context=new&animalIndex=${index}">
        <img class="edit_png" src="../img/edit_square.png" alt="edit">
      </a>
    `;
    return div;
  }

  function syncAnimalsToDraft() {
    const savedParcour = JSON.parse(
      localStorage.getItem("draft_newParcour") || '{"animals":[]}'
    );

    const names = Array.from(animalList.querySelectorAll('.animal-text'))
      .map(el => el.innerText.trim());

    if (names.length === 0) {
      savedParcour.animals = [{ name: "Tier", silhouette: null }];
    } else {
      savedParcour.animals = names.map((name, i) => ({
        name,
        silhouette: savedParcour.animals?.[i]?.silhouette || null
      }));
    }

    localStorage.setItem("draft_newParcour", JSON.stringify(savedParcour));
  }

  function validateSave() {
    const nameOk = nameInput.value.trim() !== "";
    const locOk = locInput.value.trim() !== "";
    const difficultyOk = Array.from(difficultyRadios).some(r => r.checked);

    const animals = Array.from(animalList.querySelectorAll('.animal-text'))
      .map(a => a.innerText.trim());

    const hasAnimals = animals.length > 0;
    const hasInvalidAnimal = animals.some(name => name === "" || name.toLowerCase() === "tier");

    if (nameOk && locOk && difficultyOk && hasAnimals && !hasInvalidAnimal) enableSave();
    else disableSave();
  }

  function enableSave() {
    saveBtn.disabled = false;
    saveBtn.style.opacity = "1";
    saveBtn.style.pointerEvents = "auto";
  }

  function disableSave() {
    saveBtn.disabled = true;
    saveBtn.style.opacity = "0.5";
    saveBtn.style.pointerEvents = "none";
  }

  // =========================
  // INITIAL TIERE LADEN
  // =========================
  const savedParcour = JSON.parse(
    localStorage.getItem("draft_newParcour") || '{"animals":[]}'
  );
  const animals = savedParcour.animals || [];

  animalList.innerHTML = "";
  if (animals.length > 0) {
    animals.forEach((animal, index) => {
      animalList.appendChild(createAnimalRow(animal.name, index));
    });
  } else {
    animalList.appendChild(createAnimalRow("Tier", 0));
  }

  // =========================
  // COUNTER INITIALISIEREN
  // =========================
  let currentAnimals = animalList.children.length;
  animalCounter.value = currentAnimals;
  animalCounter.min = 1;

  // =========================
  // SORTABLE.JS
  // =========================
  const sortable = Sortable.create(animalList, {
    animation: 150,
    ghostClass: 'sortable-ghost',
    handle: '.drag-handle',
    forceFallback: true,
    onEnd: refreshRowClasses
  });

  // =========================
  // COUNTER-LOGIK
  // =========================
  animalCounter.addEventListener("input", () => {
    const target = parseInt(animalCounter.value, 10);
    const current = animalList.children.length;

    if (target > current) {
      const toAdd = target - current;
      for (let i = 0; i < toAdd; i++) {
        animalList.appendChild(createAnimalRow());
      }
    }

    animalCounter.value = animalList.children.length;
    refreshRowClasses();
    syncAnimalsToDraft();
    validateSave();
  });

  // =========================
  // EVENTS
  // =========================
  nameInput.addEventListener("input", validateSave);
  locInput.addEventListener("input", validateSave);
  difficultyRadios.forEach(r => r.addEventListener("change", validateSave));

  const observer = new MutationObserver(validateSave);
  observer.observe(animalList, { childList: true, subtree: true, characterData: true });

  saveBtn.addEventListener("click", () => {
    console.log('Neue Reihenfolge:', getAnimalOrder());
  });

  // =========================
  // FINAL INITIALISIERUNG
  // =========================
  refreshRowClasses();
  validateSave();
  syncAnimalsToDraft();
});
</script>



<script>
// Nach DOMContentLoaded
document.addEventListener("DOMContentLoaded", () => {

const savedParcour = JSON.parse(
  localStorage.getItem("draft_newParcour") || '{"animals":[]}'
);
  const animals = savedParcour.animals || [];

  // 1️⃣ DOM aufbauen
  animalList.innerHTML = "";
  if (animals.length > 0) {
    animals.forEach((animal, index) => {
      const row = createAnimalRow(animal.name, index);
      animalList.appendChild(row);
    });
  } else {
    // mindestens 1 Tier
    const row = createAnimalRow("Tier", 0);
    animalList.appendChild(row);
  }

  // 2️⃣ Counter synchronisieren
  let currentAnimals = 0; // DOM bestimmt die Zahl
  currentAnimals = animalList.children.length;
  animalCounter.value = currentAnimals;

  refreshRowClasses();
  validateSave();
});


const nameInput = document.getElementById("parcour-name");
const locInput = document.getElementById("parcour-loc");
const difficultyRadios = document.querySelectorAll('input[name="difficulty"]');

// =========================
// BUTTON INITIAL DEAKTIVIEREN
// =========================
disableSave();

function disableSave() {
  saveBtn.disabled = true;
  saveBtn.style.opacity = "0.5";
  saveBtn.style.pointerEvents = "none";
}

function enableSave() {
  saveBtn.disabled = false;
  saveBtn.style.opacity = "1";
  saveBtn.style.pointerEvents = "auto";
}

// =========================
// VALIDIERUNG
// =========================
function validateSave() {
  const nameOk = nameInput.value.trim() !== "";
  const locOk = locInput.value.trim() !== "";
  const difficultyOk = Array.from(difficultyRadios).some(r => r.checked);

  const animals = Array.from(animalList.querySelectorAll('.animal-text'))
    .map(a => a.innerText.trim());

  const hasAnimals = animals.length > 0;
  const hasInvalidAnimal = animals.some(name => name === "" || name.toLowerCase() === "tier");

  if (nameOk && locOk && difficultyOk && hasAnimals && !hasInvalidAnimal) {
    enableSave();
  } else {
    disableSave();
  }
}

// =========================
// EVENTS
// =========================
nameInput.addEventListener("input", validateSave);
locInput.addEventListener("input", validateSave);
difficultyRadios.forEach(r => r.addEventListener("change", validateSave));

const observer = new MutationObserver(validateSave);
observer.observe(animalList, { childList: true, subtree: true, characterData: true });

// =========================
// SPEICHERN KLICK MIT BACKEND
// =========================
saveBtn.addEventListener("click", async () => {
  const name = nameInput.value.trim();
  const location = locInput.value.trim();
  const difficulty = Array.from(difficultyRadios).find(r => r.checked)?.value;

  const animals = Array.from(animalList.querySelectorAll('.animal-text'))
    .map(a => a.innerText.trim());

  // Validierung nochmals
  if (!name || !location || !difficulty || animals.some(a => a.toLowerCase() === "tier")) {
    alert("Bitte alle Felder korrekt ausfüllen!");
    return;
  }

  try {
    const token = localStorage.getItem("authToken");
    if (!token) throw new Error("Nicht eingeloggt");

    const response = await fetch("https://dein-backend-url/api/parcours", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({
        name,
        location,
        difficulty,
        animals,
        animalCount: animals.length
      })
    });

    if (!response.ok) throw new Error("Fehler beim Speichern des Parcours");

    alert("✅ Parcour erfolgreich erstellt!");
    localStorage.removeItem("draft_newParcour");
    window.location.href = "admin_main.html"; // Zurück zur Übersicht

  } catch (err) {
    console.error(err);
    alert("Fehler beim Erstellen des Parcours. Bitte erneut versuchen.");
  }
});

</script>
  </body>
</html>
