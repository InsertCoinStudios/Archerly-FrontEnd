<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="../css/style.css">
  </head>
  <body>
    <div class="header-bg">
      <a href="admin_main.html"><img src="../img/return.png" class="header-img"></a>
      <img src="../img/trash.png" class="header-img-2" id="deleteBtn">
    </div>
    <div class="bg-wrapper">
    <div class="bg-dark-admin">
    </div>
    <div class="bg-wrapper-2">
    <div class="bg-light-admin">

    </div>
    </div>
    </div>
    <div class="container">
    <div class="bg-wrapper-header">
  <div class="header-admin">
    <h1>
      Bearbeiten
    </h1>
      <form id="loginForm">

      <div class="data-input-admin">
      <label for="parcour-name" class="label-admin">Parkour:</label>
      <input type="text" id ="parcour-name" name="parcour-name" placeholder="Safari - Route" class="textbox-admin">
      </div>

      <div class="data-input-admin">
      <label for="parcour-loc" class="label-admin">Ort:</label>
      <input type="text" id="parcour-loc" name="parcour-loc" placeholder="Wüste 02" class="textbox-admin">
      </div>

  </form>
  </div>
  </div>

      <div class="content-top">
          <div style="text-align: left; margin-left: 20px;">
            <br>

            <p>Schwierigkeit:</p>
              <div class="radio-btns">
                <input type="radio" id="easy" name="difficulty" value="easy">
                <label for="easy">Leicht</label>
                <input type="radio" id="middle" name="difficulty" value="middle">
                <label for="middle">Mittel</label>
                <input type="radio" id="hard" name="difficulty" value="hard">
                <label for="hard">Schwer</label>
              </div>
          </div>
          <p class="divider"></p>
      </div>
      <div class="content">
        <div class="table-header">
          <p class="left">Tiere</p>
          <p class="right">
            <!-- DYNAMISCHER WERT:
             LIEST DIE ANZAHL DER TIERE IN DER TABELLE AUS
             ERLAUBT ES NICHT WENIGER, ALS DIE FIX GESETZTE ANZAHL ZU MANIPULIEREN (DAS TIER MUSS EXTRA PER KLICK GELÖSCHT WERDEN)
             ERLAUBT ES TIERE HINZUZUFÜGEN, JEDOCH MUSS DER DATENSATZ FIX BEARBEITET WERDEN-->
            Anzahl:
            <input type="number" class="animal-counter" name="counter" min="1" max="100">
          </p>
        </div>
        <div class="table_users_admin-editor">
          <!-- DYNAMISCHE ANPASSUNG: USERNAMEN, USERANZAHL -->
          <div class="non-collapse-top-admin">
            <span class="drag-handle">&#x2630;</span>
            <span class="animal-text">Löwe</span>
            <a href="admin_animal.html?ParcourId=1&animalIndex=0"><img class="edit_png" src="../img/edit_square.png" alt="edit"></a>
          </div>
          <div class="non-collapse-admin">
            <span class="drag-handle">&#x2630;</span>
            <span class="animal-text">Zebra</span>
            <a href="admin_animal.html?ParcourId=1&animalIndex=1"><img class="edit_png" src="../img/edit_square.png" alt="edit"></a>
          </div>
          <div class="non-collapse-admin">
            <span class="drag-handle">&#x2630;</span>
            <span class="animal-text">Gazelle</span>
            <a href="admin_animal.html?ParcourId=1&animalIndex=2"><img class="edit_png" src="../img/edit_square.png" alt="edit"></a>
          </div>
          <div class="non-collapse-admin">
            <span class="drag-handle">&#x2630;</span>
            <span class="animal-text">Giraffe</span>
            <a href="admin_animal.html?ParcourId=1&animalIndex=3"><img class="edit_png" src="../img/edit_square.png" alt="edit"></a>
          </div>
            <div class="non-collapse-admin">
            <span class="drag-handle">&#x2630;</span>
            <span class="animal-text">Gorilla</span>
            <a href="admin_animal.html?ParcourId=1&animalIndex=4"><img class="edit_png" src="../img/edit_square.png" alt="edit"></a>
          </div>
          <div class="non-collapse-admin">
            <span class="drag-handle">&#x2630;</span>
            <span class="animal-text">Braunbär</span>
            <a href="admin_animal.html?ParcourId=1&animalIndex=5"><img class="edit_png" src="../img/edit_square.png" alt="edit"></a>
          </div>
          <div class="non-collapse-admin">
            <span class="drag-handle">&#x2630;</span>
            <span class="animal-text">Geier</span>
            <a href="admin_animal.html?ParcourId=1&animalIndex=6"><img class="edit_png" src="../img/edit_square.png" alt="edit"></a>
          </div>
          <div class="non-collapse-bottom-admin">
            <span class="drag-handle">&#x2630;</span>
            <span class="animal-text">Elch</span>
            <a href="admin_animal.html?ParcourId=1&animalIndex=7"><img class="edit_png" src="../img/edit_square.png" alt="edit"></a>
          </div>
        </div>
        <button class="blue-btn-admin" id="saveBtn" style="float: right; margin: 10px;">
  Speichern
</button>

      </div>
    </div>
        <div class="target-circle" id="register_2-admin">
          <span class="circle1">
            <span class="circle2">
              <span class="circle3">
                <span class="circle4">
                  <span class="circle5">
                    <span class="circle6">
                    </span>
                  </span>
                </span>
              </span>
            </span>
          </span>
        </div>
<div id="leaveOverlay">
  <div id="leaveModal">
    <h3><strong>Möchtest du wirklich<br>diesen Parkour löschen?</strong></h3>

    <div class="leave-actions">
      <button id="leaveYes">Ja</button>
      <button id="leaveNo">Nein</button>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const parcourId = urlParams.get('ParcourId');

  if (!parcourId) {
    alert("Kein Parcour ausgewählt!");
    window.location.href = "admin_main.html";
    return;
  }

  // ======= BASIS-ELEMENTE =======
  const animalList = document.querySelector('.table_users_admin-editor');
  const animalCounter = document.querySelector('.animal-counter');
  const nameInput = document.getElementById("parcour-name");
  const locInput = document.getElementById("parcour-loc");
  const difficultyRadios = document.querySelectorAll('input[name="difficulty"]');
  const saveBtn = document.getElementById("saveBtn");

  // ======= EXISTIERENDE TIERE LADEN =======
  const savedParcours = JSON.parse(localStorage.getItem("parcours_" + parcourId) || "{}");
  const animals = savedParcours.animals || [];

  animalList.innerHTML = "";
  if (animals.length > 0) {
    animals.forEach((animal, index) => {
      animalList.appendChild(createAnimalRow(animal.name, index));
    });
  } else {
    animalList.appendChild(createAnimalRow("Tier", 0));
  }

  // ======= COUNTER INITIAL =======
  let currentAnimals = animalList.children.length;
  let minAnimals = currentAnimals;
  animalCounter.value = currentAnimals;
  animalCounter.min = minAnimals;

  // ======= FUNKTIONEN =======
  function createAnimalRow(name = 'Tier', index = null) {
    if (index === null) index = animalList.children.length;
    const div = document.createElement('div');
    div.className = 'non-collapse-admin';
    div.innerHTML = `
      <span class="drag-handle">&#x2630;</span>
      <span class="animal-text">${name}</span>
      <a href="admin_animal.html?ParcourId=${parcourId}&animalIndex=${index}">
        <img class="edit_png" src="../img/edit_square.png" alt="edit">
      </a>
    `;
    return div;
  }

  function refreshRowClasses() {
    const rows = Array.from(animalList.children);
    rows.forEach(row => {
      row.classList.remove('non-collapse-top-admin','non-collapse-bottom-admin','non-collapse-admin');
      row.classList.add('non-collapse-admin');
    });
    if (rows.length > 0) {
      rows[0].classList.replace('non-collapse-admin','non-collapse-top-admin');
      rows[rows.length-1].classList.replace('non-collapse-admin','non-collapse-bottom-admin');
    }
  }

  function validateSave() {
    const nameOk = nameInput.value.trim() !== "";
    const locOk = locInput.value.trim() !== "";
    const difficultyOk = Array.from(difficultyRadios).some(r => r.checked);

    const animalsArr = Array.from(animalList.querySelectorAll('.animal-text')).map(a => a.innerText.trim());
    const hasAnimals = animalsArr.length > 0;
    const hasInvalidAnimal = animalsArr.some(a => a === "" || a.toLowerCase() === "tier");

    if (nameOk && locOk && difficultyOk && hasAnimals && !hasInvalidAnimal) enableSave();
    else disableSave();
  }

  function disableSave() {
    saveBtn.disabled = true;
    saveBtn.style.opacity = "0.5";
    saveBtn.style.pointerEvents = "none";
  }
  function enableSave() {
    saveBtn.disabled = false;
    saveBtn.style.opacity = "1";
    saveBtn.style.pointerEvents = "auto";
  }

  // ======= EVENTS =======
  nameInput.addEventListener("input", validateSave);
  locInput.addEventListener("input", validateSave);
  difficultyRadios.forEach(r => r.addEventListener("change", validateSave));

  // MutationObserver für Tieränderungen
  const observer = new MutationObserver(validateSave);
  observer.observe(animalList, { childList: true, subtree: true, characterData: true });

  // ======= COUNTER LOGIK =======
  animalCounter.addEventListener('input', () => {
    let target = parseInt(animalCounter.value, 10);

    if (target < minAnimals) {
      animalCounter.value = currentAnimals;
      return;
    }

    while (currentAnimals < target) {
      animalList.appendChild(createAnimalRow());
      currentAnimals++;
    }

    minAnimals = currentAnimals;
    animalCounter.min = minAnimals;
    animalCounter.value = currentAnimals;

    refreshRowClasses();
    validateSave();
  });

  // ======= SORTABLE.JS =======
  Sortable.create(animalList, {
    animation: 150,
    ghostClass: 'sortable-ghost',
    handle: '.drag-handle',
    forceFallback: true,
    onEnd: refreshRowClasses
  });

  // ======= SAVE BUTTON =======
  saveBtn.addEventListener("click", () => {
    const animalsArr = Array.from(animalList.querySelectorAll('.animal-text')).map(a => a.innerText.trim());
    if (animalsArr.some(a => a.toLowerCase() === "tier")) {
      alert("Bitte alle Tiere benennen!");
      return;
    }

    localStorage.setItem("parcours_" + parcourId, JSON.stringify({
      ...savedParcours,
      animals: animalsArr
    }));

    alert("✅ Parcour erfolgreich gespeichert!");
  });

  // ======= INITIAL =======
  refreshRowClasses();
  validateSave();
});
</script>


  </body>
</html>
