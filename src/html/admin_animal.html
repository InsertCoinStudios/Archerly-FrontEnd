<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tier bearbeiten</title>
    <link rel="stylesheet" href="../css/style.css">
  </head>
  <body>
    <div class="header-bg">
      <img src="../img/return.png" class="header-img" id="returnBtn">
      <img src="../img/trash.png" class="header-img-2" id="deleteBtn">
    </div>
    <div class="bg-wrapper">
    <div class="bg-dark-admin">
    </div>
    <div class="bg-wrapper-2">
    <div class="bg-light-admin">

    </div>
    </div>
    </div>
    <div class="container">
    <div class="bg-wrapper-header">
  <div class="header-admin">
    <h1>
      Tier bearbeiten
    </h1>
      <form id="editAnimalForm">

      <div class="data-input-admin">
      <label for="animal-name" class="label-admin">Name:</label>
      <input type="text" id ="animal-name" name="animal-name" placeholder="Tier" class="textbox-admin">
      </div>
  
  </form>
  </div>
  </div>

      <div class="content-top">

      </div>
      <div class="content">
        <div class="silhouettes-grid"></div>
        

        <button class="blue-btn-admin" id="saveBtn" style="float: right; margin: 10px;">
  Speichern
</button>

      </div>
      <div class="footer">
        <div class="target-circle" id="hunt_join_2">
          <span class="circle1">
            <span class="circle2">
              <span class="circle3">
                <span class="circle4">
                  <span class="circle5">
                    <span class="circle6">
                    </span>
                  </span>
                </span>
              </span>
            </span>
          </span>
        </div> 
      </div>
    </div>
<div id="leaveOverlay">
  <div id="leaveModal">
    <h3><strong>M√∂chtest du wirklich<br>dieses Tier vom Parkour entfernen?</strong></h3>

    <div class="leave-actions">
      <button id="leaveYes">Ja</button>
      <button id="leaveNo">Nein</button>
    </div>
  </div>
</div>
<script>
  const deleteBtn = document.getElementById("deleteBtn");
  const overlay = document.getElementById("leaveOverlay");
  const yesBtn = document.getElementById("leaveYes");
  const noBtn = document.getElementById("leaveNo");

  deleteBtn.addEventListener("click", () => {
    overlay.style.display = "flex";
  });

yesBtn.addEventListener("click", async () => {
  if (!currentParcour.animals || isNaN(animalIndex)) {
    window.history.back();
    return;
  }

  // üö´ MINDESTENS 1 TIER MUSS BLEIBEN
  if (currentParcour.animals.length <= 1) {
    alert("Mindestens ein Tier muss im Parcour enthalten sein.");
    overlay.style.display = "none";
    return;
  }

  // üóëÔ∏è Tier entfernen
  currentParcour.animals.splice(animalIndex, 1);


  // üÜï NEUER PARCOUR ‚Üí Draft aktualisieren
  if (context === "new") {
    localStorage.setItem(
      "draft_newParcour",
      JSON.stringify(currentParcour)
    );
    window.history.back();
    return;
  }

  // ‚úèÔ∏è BESTEHENDER PARCOUR ‚Üí Backend
  if (context === "existing") {
    try {
      const token = localStorage.getItem("authToken");

      const response = await fetch(
        `https://dein-backend-url/api/parcours/${parcourId}/animals`,
        {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify(currentParcour.animals)
        }
      );

      if (!response.ok) throw new Error("Fehler beim L√∂schen");

      alert("Tier erfolgreich entfernt");
      window.history.back();
    } catch (err) {
      console.error(err);
      alert("Fehler beim Entfernen des Tiers");
    }
  }
});


  noBtn.addEventListener("click", () => {
    overlay.style.display = "none";
  });

  overlay.addEventListener("click", (e) => {
  if (e.target === overlay) {
    overlay.style.display = "none";
  }
});

</script>
<script>
const urlParams = new URLSearchParams(window.location.search);

const context = urlParams.get("context"); // "existing" | "new"
const parcourId = urlParams.get("parcourId"); // nur bei existing relevant
const animalIndex = parseInt(urlParams.get("animalIndex"), 10);


const nameInput = document.getElementById("animal-name");
const saveBtn = document.getElementById("saveBtn");
const grid = document.querySelector(".silhouettes-grid");

let selectedBox = null;
let currentParcour = { animals: [] };

// 1Ô∏è‚É£ Silhouetten erzeugen
const totalBoxes = 12;
for (let i = 1; i <= totalBoxes; i++) {
  const box = document.createElement("div");
  box.classList.add("silhouette-box-admin");
  box.textContent = `Tier ${i}`;
  box.dataset.id = i;

  box.addEventListener("click", () => {
    document.querySelectorAll(".silhouette-box-admin.selected")
      .forEach(b => b.classList.remove("selected"));
    box.classList.add("selected");
    selectedBox = box;
    validateSaveButton();
  });

  grid.appendChild(box);
}

// 2Ô∏è‚É£ Parcour laden
if (context === "new") {
  currentParcour = JSON.parse(
    localStorage.getItem("draft_newParcour") || '{"animals":[]}'
  );

  loadAnimal();

  // üõ°Ô∏è Delete-Button nur anzeigen, wenn Tier existiert
    if (currentParcour.animals.length <= 1) {
      deleteBtn.style.display = "none";
    }
}


if (context === "existing") {
  // ‚úèÔ∏è Bestehender Parcour ‚Üí Backend
  fetch(`https://dein-backend-url/api/parcours/${parcourId}`, {
    headers: {
      "Authorization": `Bearer ${localStorage.getItem("authToken")}`
    }
  })
    .then(res => res.json())
    .then(data => {
      currentParcour = data;
      loadAnimal();
    });
}


// 3Ô∏è‚É£ Tierdaten laden
function loadAnimal() {
  const animal = currentParcour.animals[animalIndex];
  if (!animal) return;

  nameInput.value = animal.name;

  // Silhouette markieren
  const box = grid.querySelector(`.silhouette-box-admin[data-id="${animal.silhouette}"]`);
  if (box) {
    box.classList.add("selected");
    selectedBox = box;
  }

  validateSaveButton();
}

// 4Ô∏è‚É£ Save Button validieren
function validateSaveButton() {
  const hasValidName = nameInput.value.trim() !== "" && nameInput.value.toLowerCase() !== "tier";
  const hasSelection = selectedBox !== null;

  if (hasValidName && hasSelection) {
    saveBtn.disabled = false;
    saveBtn.style.opacity = "1";
    saveBtn.style.pointerEvents = "auto";
  } else {
    saveBtn.disabled = true;
    saveBtn.style.opacity = "0.5";
    saveBtn.style.pointerEvents = "none";
  }
}

nameInput.addEventListener("input", validateSaveButton);

// 5Ô∏è‚É£ Speichern
saveBtn.addEventListener("click", async () => {
  const name = nameInput.value.trim();
  if (!selectedBox || !name) {
    alert("Bitte Name und Silhouette ausw√§hlen!");
    return;
  }

  const animalData = { name, silhouette: selectedBox.dataset.id };

  if (!currentParcour.animals) currentParcour.animals = [];

  // Neues Tier oder bestehendes √ºberschreiben
  if (isNaN(animalIndex) || animalIndex >= currentParcour.animals.length) {
    currentParcour.animals.push(animalData);
  } else {
    currentParcour.animals[animalIndex] = animalData;
  }

if (context === "new") {
  // üÜï Nur Draft speichern
  localStorage.setItem(
    "draft_newParcour",
    JSON.stringify(currentParcour)
  );
  window.history.back();
  return;
} else {
    try {
      const token = localStorage.getItem("authToken");
      const response = await fetch(`https://dein-backend-url/api/parcours/${parcourId}/animals`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(currentParcour.animals)
      });

      if (!response.ok) throw new Error("Fehler beim Speichern");

      alert("Tier erfolgreich aktualisiert!");
      window.history.back();
    } catch (err) {
      console.error(err);
      alert("Fehler beim Speichern des Tiers.");
    }
  }
});

</script>

<script>
  document.getElementById("returnBtn").addEventListener("click", () => {
    if (window.history.length > 1) {
      window.history.back();
    } else {
      // Fallback, falls Seite direkt ge√∂ffnet wurde
      window.location.href = "admin_main.html";
    }
  });
</script>

  </body>
</html>
